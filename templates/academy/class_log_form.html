<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¼ì§€ ì‘ì„±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .app-container { max-width: 600px; margin: 0 auto; background-color: white; min-height: 100vh; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: #6c757d; margin-bottom: 10px; margin-top: 20px;}
        .form-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 3px; }
        .book-entry { position: relative; }
        .remove-btn { position: absolute; top: 5px; right: 5px; z-index: 10; }
    </style>
</head>
<body>

<div class="app-container shadow-sm">
    <div class="px-3 py-3 border-bottom d-flex align-items-center justify-content-between sticky-top bg-white">
        <a href="javascript:history.back()" class="btn btn-sm btn-light">âŒ ì·¨ì†Œ</a>
        <h5 class="m-0 fw-bold">{{ student.name }}</h5>
        <button type="submit" form="logForm" class="btn btn-sm btn-primary px-3">ğŸ’¾ ì €ì¥</button>
    </div>

    <div class="p-3">
        <div class="alert alert-light border mb-3">
            <small class="text-muted d-block">ìˆ˜ì—… ì •ë³´</small>
            <strong>{{ schedule.new_date }} ({{ schedule.get_subject_display }})</strong>
        </div>

        <form id="logForm" method="POST">
            {% csrf_token %}
            
            <div class="section-title">ğŸ“• ë‹¨ì–´ í…ŒìŠ¤íŠ¸</div>
            <div id="vocab-container">
                </div>
            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addVocabEntry()">+ êµì¬ ì¶”ê°€</button>
            </div>

            <div class="section-title">ğŸ“˜ ìˆ˜ì—… ì§„ë„</div>
            <div id="main-container">
                <!-- ì²« ë²ˆì§¸ ì§„ë„ êµì¬ ì…ë ¥ í¼ -->
                </div>
            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addMainEntry()">+ êµì¬ ì¶”ê°€</button>
            </div>

            <div class="section-title">ğŸ’¬ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸</div>
            <textarea class="form-control" rows="3" name="comment" placeholder="í•™ìƒì˜ íƒœë„ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”.">{{ existing_comment }}</textarea>

            <div class="section-title mt-4">ğŸ  ë‹¤ìŒ ê³¼ì œ ë° ì•Œë¦¼</div>
                <div class="card p-3 border border-primary-subtle bg-primary-subtle mb-3">
                    
                    <div class="row g-2 mb-3">
                        <div class="col-12">
                            <label class="form-label small text-primary fw-bold">ğŸ“• ë‹¨ì–´ ê³¼ì œ</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select" name="hw_vocab_book_id" style="max-width: 40%;">
                                    <option value="">ë‹¨ì–´ì¥ ì„ íƒ</option>
                                    {% for book in vocab_books %}
                                        <option value="{{ book.id }}" {% if class_log.hw_vocab_book_id == book.id %}selected{% endif %}>{{ book.title }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control" name="hw_vocab_range" placeholder="ë²”ìœ„ (ì˜ˆ: Day 6-10)" value="{{ class_log.hw_vocab_range|default:'' }}">
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label small text-primary fw-bold">ğŸ“˜ êµ¬ë¬¸/ë…í•´ ê³¼ì œ</label>
                            <div class="input-group input-group-sm">
                                <select class="form-select" name="hw_main_book_id" style="max-width: 40%;">
                                    <option value="">êµì¬ ì„ íƒ</option>
                                    {% for book in syntax_books %}
                                        <option value="{{ book.id }}" {% if class_log.hw_main_book_id == book.id %}selected{% endif %}>{{ book.title }}</option>
                                    {% endfor %}
                                    {% for book in reading_books %}
                                        <option value="{{ book.id }}" {% if class_log.hw_main_book_id == book.id %}selected{% endif %}>{{ book.title }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control" name="hw_main_range" placeholder="ë²”ìœ„ (ì˜ˆ: 5-7ê°•, p.20-30)" value="{{ class_log.hw_main_range|default:'' }}">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-primary fw-bold">ğŸ’¬ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸ (ì•Œë¦¼í†¡ í¬í•¨)</label>
                        <textarea class="form-control" rows="2" name="teacher_comment" placeholder="ê³¼ì œ ê´€ë ¨ ë‹¹ë¶€ì‚¬í•­ì´ë‚˜ ê²©ë ¤ì˜ ë§ì„ ì ì–´ì£¼ì„¸ìš”.">{{ class_log.teacher_comment|default:'' }}</textarea>
                    </div>

                    <hr class="border-primary">

                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            {% if class_log.notification_sent_at %}
                                <div class="text-success small fw-bold">
                                    <i class="bi bi-check-circle-fill"></i> ë°œì†¡ ì™„ë£Œ: {{ class_log.notification_sent_at|date:"m/d H:i" }}
                                </div>
                            {% else %}
                                <div class="text-muted small">
                                    <i class="bi bi-dash-circle"></i> ì•„ì§ ë°œì†¡ë˜ì§€ ì•ŠìŒ
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="sendNotification" name="send_notification" value="on"
                                {% if not class_log.notification_sent_at %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="sendNotification">ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ ë°œì†¡</label>
                        </div>
                    </div>
                </div>
        </form>
    </div>
</div>

<script>
    // 1. ì„œë²„ì—ì„œ ë°ì´í„° ë°›ê¸°
    const syntaxBooks = {{ syntax_books_json|safe }};
    const readingBooks = {{ reading_books_json|safe }};
    const grammarBooks = {{ grammar_books_json|safe }};

    // ì•ˆì „í•œ íŒŒì‹± (ë‹¨ì–´ì¥)
    let vocabBooksByPublisher = {};
    try { vocabBooksByPublisher = {{ vocab_books_json|safe }}; } catch (e) {}

    // ê¸°ì¡´ ì¼ì§€ ë°ì´í„°
    let existingVocabEntries = [];
    let existingMainEntries = [];
    try {
        existingVocabEntries = {{ existing_vocab_entries|safe|default:"[]" }};
        existingMainEntries = {{ existing_main_entries|safe|default:"[]" }};
    } catch (e) {}

    // [NEW] ìë™ ì±„ìš°ê¸° ë°ì´í„° (views.pyì—ì„œ ë„˜ê²¨ì¤€ ë°ì´í„°)
    let autoVocabData = null;
    try {
        autoVocabData = {{ auto_vocab_data|safe|default:"null" }};
    } catch (e) {}


    // 2. ë‹¨ì–´ì¥ êµì¬ ëª©ë¡ í•„í„°ë§ í•¨ìˆ˜
    function filterVocabBooks(publisherSelect) {
        const bookSelect = publisherSelect.closest('.book-entry').querySelector('.vocab-book-select');
        const selectedPublisher = publisherSelect.value;
        
        bookSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
        
        if (!selectedPublisher || !vocabBooksByPublisher[selectedPublisher]) {
            bookSelect.disabled = true;
            return;
        }
        
        const books = vocabBooksByPublisher[selectedPublisher];
        books.forEach(book => {
            const option = document.createElement('option');
            option.value = book.id;
            option.textContent = book.title;
            bookSelect.appendChild(option);
        });
        bookSelect.disabled = false;
    }

    // 3. ì§„ë„ êµì¬ ëª©ë¡ í•„í„°ë§ í•¨ìˆ˜
    function filterBooks(subjectSelect) {
        const bookSelect = subjectSelect.closest('.book-entry').querySelector('.main-book-select');
        const selectedSubject = subjectSelect.value;
        
        bookSelect.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>';
        
        let books = [];
        if (selectedSubject === 'SYNTAX') books = syntaxBooks;
        else if (selectedSubject === 'READING') books = readingBooks;
        else if (selectedSubject === 'GRAMMAR') books = grammarBooks; // ğŸ‘ˆ ì´ ì¤„ ì¶”ê°€!
        else {
        bookSelect.disabled = true;
        return;
        }

        books.forEach(book => {
            const option = document.createElement('option');
            option.value = book.id;
            option.textContent = book.title;
            bookSelect.appendChild(option);
        });
        bookSelect.disabled = false;
    }

    // ============================================================
    // [í•µì‹¬] ë‹¨ì–´ì¥ ì…ë ¥ì¹¸ ì¶”ê°€ í•¨ìˆ˜ (í†µí•© ë²„ì „)
    // ============================================================
    function addVocabEntry(data = null) {
        const container = document.getElementById('vocab-container');
        const newEntry = document.createElement('div');
        newEntry.className = 'card p-3 bg-light border-0 mb-3 book-entry';
        
        // ë°ì´í„° ì´ˆê¸°ê°’ ì„¤ì •
        const bookId = data ? (data.wordbook_id || data.book_id || '') : '';
        const rangeVal = data ? (data.range || data.test_range || '') : '';
        const scoreVal = data ? (data.score || '') : '';
        const publisherVal = data ? (data.publisher || '') : ''; // ê¸°ì¡´ ë°ì´í„°ìš©
        
        // ìë™ ì±„ìš°ê¸° ì •ë³´ í‘œì‹œìš© í…ìŠ¤íŠ¸
        let infoBadge = '';
        let infoText = '';
        if (data && data.isAuto) {
            infoBadge = `<span class="badge bg-warning text-dark ms-1" style="font-size: 0.6em;">Online</span>`;
            infoText = `<div class="form-text text-success fw-bold mt-1" style="font-size: 0.75rem;">
                            <i class="bi bi-magic"></i> ìµœê³ ê¸°ë¡: ${scoreVal}ì  (${data.count}íšŒ ì‹œë„)
                        </div>`;
        }

        // ì¶œíŒì‚¬ ì˜µì…˜ HTML ìƒì„±
        let publisherOptions = '<option value="">ì¶œíŒì‚¬</option>';
        {% for publisher in vocab_publishers %}
            publisherOptions += `<option value="{{ publisher }}">{{ publisher }}</option>`;
        {% endfor %}

        newEntry.innerHTML = `
            <button type="button" class="btn btn-sm btn-danger remove-btn" onclick="this.parentElement.remove()">Ã—</button>
            <div class="mb-2">
                <label class="form-label">êµì¬ ì„ íƒ</label>
                <div class="row g-2">
                    <div class="col-4">
                        <select class="form-select form-select-sm vocab-publisher-select" onchange="filterVocabBooks(this)">
                            ${publisherOptions}
                        </select>
                    </div>
                    <div class="col-8">
                        <select class="form-select form-select-sm vocab-book-select" name="vocab_book_ids[]" disabled>
                            <option value="">ì¶œíŒì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row g-2">
                <div class="col-8">
                    <label class="form-label">ë²”ìœ„ (ìˆ«ìë§Œ)</label>
                    <input type="text" class="form-control form-control-sm" name="vocab_ranges[]" 
                           placeholder="ì˜ˆ: 5 ë˜ëŠ” 1-3" pattern="[0-9\-]+" value="${rangeVal}">
                </div>
                <div class="col-4">
                    <label class="form-label">ì ìˆ˜ ${infoBadge}</label>
                    <input type="text" class="form-control form-control-sm" name="vocab_scores[]" 
                           placeholder="ì ìˆ˜" value="${scoreVal}">
                    ${infoText}
                </div>
            </div>
        `;
        
        container.appendChild(newEntry);

        // [ë¡œì§] ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìë™ ì„ íƒ
        if (data) {
            // 1. ì¶œíŒì‚¬ ì°¾ê¸° (IDë¡œ ì—­ì¶”ì í•˜ê±°ë‚˜, ì €ì¥ëœ ì¶œíŒì‚¬ëª… ì‚¬ìš©)
            const pubSelect = newEntry.querySelector('.vocab-publisher-select');
            
            // ê¸°ì¡´ ë°ì´í„°(publisherVal)ê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì„ íƒ
            let targetPublisher = publisherVal;

            // ìë™ ë°ì´í„°(bookId)ë§Œ ìˆê³  ì¶œíŒì‚¬ë¥¼ ëª¨ë¥¼ ê²½ìš° -> ì—­ì¶”ì 
            if (!targetPublisher && bookId) {
                for (const [pub, books] of Object.entries(vocabBooksByPublisher)) {
                    if (books.some(b => b.id == bookId)) {
                        targetPublisher = pub;
                        break;
                    }
                }
            }

            if (targetPublisher) {
                pubSelect.value = targetPublisher;
                filterVocabBooks(pubSelect); // ì±… ëª©ë¡ ë¡œë“œ

                // ì±… ì„ íƒ (ë¹„ë™ê¸° ì´ìŠˆ ë°©ì§€ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° ì—†ì´ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì „í•˜ê²Œ)
                const bookSelect = newEntry.querySelector('.vocab-book-select');
                if (bookSelect) bookSelect.value = bookId;
            }
        }
    }

    // 5. ì§„ë„ êµì¬ ì…ë ¥ì¹¸ ì¶”ê°€ í•¨ìˆ˜
    function addMainEntry(data = null) {
        const container = document.getElementById('main-container');
        const newEntry = document.createElement('div');
        newEntry.className = 'card p-3 border-0 mb-3 book-entry';
        
        const textbookId = data ? (data.textbook_id || '') : '';
        const rangeVal = data ? (data.range || '') : '';
        const scoreVal = data ? (data.score || '') : '';
        const categoryVal = data ? (data.category || '') : '';

        newEntry.innerHTML = `
            <button type="button" class="btn btn-sm btn-danger remove-btn" onclick="this.parentElement.remove()">Ã—</button>
            <div class="mb-2">
                <label class="form-label">êµì¬ ì„ íƒ</label>
                <div class="row g-2">
                    <div class="col-3">
                        <select class="form-select form-select-sm main-subject-select" onchange="filterBooks(this)">
                            <option value="">ê³¼ëª©</option>
                            <option value="SYNTAX" ${categoryVal === 'SYNTAX' ? 'selected' : ''}>ğŸ“˜ êµ¬ë¬¸</option>
                            <option value="READING" ${categoryVal === 'READING' ? 'selected' : ''}>ğŸ“™ ë…í•´</option>
                            <option value="GRAMMAR" ${categoryVal === 'GRAMMAR' ? 'selected' : ''}>ğŸ“— ì–´ë²•</option> </select>
                        </select>
                    </div>
                    <div class="col-9">
                        <select class="form-select form-select-sm main-book-select" name="main_book_ids[]" disabled>
                            <option value="">ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row g-2 mb-2">
                <div class="col-8">
                    <label class="form-label">ì§„ë„ ë²”ìœ„ (ìˆ«ìë§Œ)</label>
                    <input type="text" class="form-control form-control-sm" name="main_ranges[]" 
                           placeholder="ì˜ˆ: 5 ë˜ëŠ” 3-7" pattern="[0-9\-]+" value="${rangeVal}">
                    <div class="form-text" style="font-size: 10px;">* ê·¸ë˜í”„ìš© (ìˆ«ì ë˜ëŠ” ë²”ìœ„ë§Œ ì…ë ¥)</div>
                </div>
                <div class="col-4">
                    <label class="form-label">ìˆ˜í–‰ë„</label>
                    <select class="form-select form-select-sm" name="main_scores[]">
                        <option value="A" ${scoreVal === 'A' ? 'selected' : ''}>A (ì´í•´ ì™„ë²½)</option>
                        <option value="B" ${scoreVal === 'B' ? 'selected' : ''}>B (ëŒ€ì²´ë¡œ ì´í•´)</option>
                        <option value="C" ${scoreVal === 'C' ? 'selected' : ''}>C (ë³´ì¶© í•„ìš”)</option>
                    </select>
                </div>
            </div>
        `;
        
        container.appendChild(newEntry);

        // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì±… ì„ íƒ íŠ¸ë¦¬ê±°
        if (categoryVal) {
            const subjectSelect = newEntry.querySelector('.main-subject-select');
            filterBooks(subjectSelect); // ì±… ëª©ë¡ ë¡œë“œ
            const bookSelect = newEntry.querySelector('.main-book-select');
            if (bookSelect) bookSelect.value = textbookId;
        }
    }

    // ============================================================
    // [í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰] - ì—¬ê¸°ì„œ ìë™/ìˆ˜ë™ ì—¬ë¶€ ê²°ì •!
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. ë‹¨ì–´ì¥ ì²˜ë¦¬
        const vocabContainer = document.getElementById('vocab-container');
        
        // Case A: ê¸°ì¡´ ì‘ì„±ëœ ì¼ì§€ê°€ ìˆëŠ” ê²½ìš° (ìˆ˜ì • ëª¨ë“œ) -> ê·¸ëŒ€ë¡œ ë¶ˆëŸ¬ì˜´
        if (existingVocabEntries && existingVocabEntries.length > 0) {
            existingVocabEntries.forEach(entry => addVocabEntry(entry));
        }
        // Case B: ì‘ì„±ëœ ì¼ì§€ëŠ” ì—†ì§€ë§Œ, ì˜¤ëŠ˜ ë³¸ ì˜¨ë¼ì¸ ì‹œí—˜ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš° (ìë™ ì±„ìš°ê¸°)
        else if (autoVocabData) {
            // isAuto í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•´ì„œ addVocabEntryì— ë„˜ê¹€
            autoVocabData.isAuto = true;
            addVocabEntry(autoVocabData);
        }
        // Case C: ì•„ë¬´ê²ƒë„ ì—†ëŠ” ê²½ìš° -> ë¹ˆ ì¹¸ í•˜ë‚˜ ì¶”ê°€
        else {
            addVocabEntry(); 
        }

        // 2. ì§„ë„ êµì¬ ì²˜ë¦¬
        const mainContainer = document.getElementById('main-container');
        if (existingMainEntries && existingMainEntries.length > 0) {
            existingMainEntries.forEach(entry => addMainEntry(entry));
        } else {
            addMainEntry(); // ì—†ìœ¼ë©´ ë¹ˆ ì¹¸ í•˜ë‚˜
        }
    });
</script>

</body>
</html>