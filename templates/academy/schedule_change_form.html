<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì • ë³€ê²½ ë° ë³´ê°• ì„¤ì •</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .form-card { max-width: 500px; width: 100%; border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0; padding: 20px; }
    </style>
</head>
<body>
    <div class="card form-card">
        <div class="header-gradient text-center">
            <h4 class="mb-1">ğŸ“… ì¼ì • ë³€ê²½ / ë³´ê°• ì„¤ì •</h4>
            <p class="mb-0 opacity-75">{{ student.name }} í•™ìƒ</p>
        </div>
        <div class="card-body p-4">
            <form method="post">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label class="form-label fw-bold">ê³¼ëª©</label>
                    <select name="subject" id="subjectSelect" class="form-select">
                        <option value="SYNTAX" {% if initial_subject == 'SYNTAX' %}selected{% endif %}>êµ¬ë¬¸ (Syntax)</option>
                        <option value="READING" {% if initial_subject == 'READING' %}selected{% endif %}>ë…í•´ (Reading)</option>
                    </select>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-7">
                        <label class="form-label fw-bold">ë³€ê²½í•  ë‚ ì§œ</label>
                        <input type="date" name="new_date" class="form-control" required value="{{ today|date:'Y-m-d' }}">
                    </div>
                    <div class="col-5">
                        <label class="form-label fw-bold">ì‹œê°„</label>
                        <select name="new_time" id="timeSelect" class="form-select text-center fw-bold" required style="cursor: pointer;">
                            <option value="" disabled selected>ì‹œê°„ ì„ íƒ</option>
                            </select>
                    </div>
                </div>

                <div class="mb-3 form-check form-switch p-3 bg-light rounded border">
                    <input class="form-check-input ms-0 me-2" type="checkbox" name="is_extra" id="isExtraCheck">
                    <label class="form-check-label fw-bold" for="isExtraCheck">
                        ì •ê·œ ìˆ˜ì—… ì™¸ <span class="text-primary">ì¶”ê°€ ë³´ì¶©</span>ì¸ê°€ìš”?
                    </label>
                    <div class="form-text mt-1 ms-1" style="font-size: 0.85rem;">
                        ì²´í¬ í•´ì œ ì‹œ: ê¸°ì¡´ ìˆ˜ì—…ì„ ë¯¸ë£¨ëŠ” 'ì¼ì • ë³€ê²½'ìœ¼ë¡œ ì²˜ë¦¬<br>
                        ì²´í¬ ì‹œ: ì›ë˜ ìˆ˜ì—…ë„ ìˆê³ , ì´ ë‚  ë˜ ë‚˜ì˜¤ëŠ” 'ë³´ê°•'ìœ¼ë¡œ ì²˜ë¦¬
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">ë©”ëª¨</label>
                    <input type="text" name="note" class="form-control" placeholder="ì˜ˆ: ë³‘ì› ì§„ë£Œë¡œ ì¸í•œ ì‹œê°„ ë³€ê²½">
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary py-2 fw-bold">ì¼ì • ì„¤ì •í•˜ê¸°</button>
                    <a href="{% url 'academy:class_management' %}" class="btn btn-outline-secondary">ì·¨ì†Œ</a>
                </div>
            </form>
        </div>
    </div>

<script>
        // íŒŒì´ì¬ ë°ì´í„°
        const weekdaySyntax = JSON.parse('{{ weekday_syntax_json|safe }}');
        const weekdayReading = JSON.parse('{{ weekday_reading_json|safe }}');
        const weekendSyntax = JSON.parse('{{ weekend_syntax_json|safe }}');
        const weekendReading = JSON.parse('{{ weekend_reading_json|safe }}');

        const subjectSelect = document.getElementById('subjectSelect');
        const timeSelect = document.getElementById('timeSelect');
        const dateInput = document.querySelector('input[name="new_date"]');
        
        // í•™ìƒ ID (URL ë“±ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ ì£¼ì…)
        const studentId = "{{ student.id }}"; 

        // 1. ì‹œê°„ ëª©ë¡ ì—…ë°ì´íŠ¸ + ì˜ˆì•½ í™•ì¸ í•¨ìˆ˜
        async function updateTimeOptions() {
            const subject = subjectSelect.value;
            const dateValue = dateInput.value;
            
            if (!dateValue) return; 

            // (1) ê¸°ë³¸ ì‹œê°„í‘œ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const day = new Date(dateValue).getDay();
            const isWeekend = (day === 0 || day === 6);
            let times = [];

            if (isWeekend) {
                times = (subject === 'READING') ? weekendReading : weekendSyntax;
            } else {
                times = (subject === 'READING') ? weekdayReading : weekdaySyntax;
            }

            // ì´ˆê¸°í™”
            timeSelect.innerHTML = '<option value="" disabled selected>ë¡œë”© ì¤‘...</option>';
            timeSelect.disabled = true;

            try {
                // (2) ì„œë²„ì— "ì´ ë‚ ì§œ ì˜ˆì•½ëœ ì‹œê°„ ì•Œë ¤ì¤˜!" ìš”ì²­ (AJAX)
                const response = await fetch(`/academy/api/availability/?student_id=${studentId}&subject=${subject}&date=${dateValue}`);
                const data = await response.json();
                const bookedTimes = data.booked; // ì˜ˆ: ['16:00', '17:20']

                // (3) ì˜µì…˜ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                timeSelect.innerHTML = '<option value="" disabled selected>ì‹œê°„ ì„ íƒ</option>';
                
                times.forEach(function(time) {
                    const option = document.createElement('option');
                    option.value = time;
                    
                    // ì˜ˆì•½ëœ ì‹œê°„ì´ë©´ (bookedTimesì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´)
                    if (bookedTimes.includes(time)) {
                        option.text = `${time} (ë§ˆê°)`;
                        option.disabled = true; // ì„ íƒ ë¶ˆê°€!
                        option.style.color = '#ccc'; // íšŒìƒ‰ ì²˜ë¦¬
                    } else {
                        option.text = time;
                    }
                    timeSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error fetching availability:', error);
                timeSelect.innerHTML = '<option value="" disabled selected>ì˜¤ë¥˜ ë°œìƒ</option>';
            } finally {
                timeSelect.disabled = false;
            }
        }

        subjectSelect.addEventListener('change', updateTimeOptions);
        dateInput.addEventListener('change', updateTimeOptions);

        // ì´ˆê¸° ì‹¤í–‰
        updateTimeOptions();
    </script>
</body>
</html>