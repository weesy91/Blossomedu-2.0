<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‹¨ì–´ ì‹œí—˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* í„°ì¹˜ ë°˜ì‘ ì†ë„ ìµœì í™” */
        body { 
            background-color: #f8f9fa; 
            touch-action: manipulation; 
            overscroll-behavior: none;
        } 
        
        .exam-card {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            min-height: 100vh; /* í™”ë©´ ê½‰ ì°¨ê²Œ */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ ë° ìµœì†Œ ë„ˆë¹„ í™•ë³´ */
        .result-table .btn {
            white-space: nowrap; /* ê¸€ì ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
            min-width: 60px;     /* ìµœì†Œ ë„ˆë¹„ ì§€ì • */
            padding: 4px 10px !important;
        }

        /* ë‹¨ì–´ í…ìŠ¤íŠ¸ */
        .word-display {
            font-size: 2.5rem;
            font-weight: 800;
            color: #212529;
            margin: 10px 0;
            word-break: break-all;
        }

        /* ë°œìŒ ì•„ì´ì½˜ */
        .pronunciation-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: #e7f1ff;
            color: #0d6efd;
            font-size: 1.2rem;
            margin-left: 10px;
            cursor: pointer;
            /* í„°ì¹˜ ì¸ì‹ ê°œì„  */
            position: relative; 
            z-index: 10; 
        }

        /* íƒ€ì´ë¨¸ ë°” */
        .timer-container {
            height: 6px;
            background-color: #e9ecef;
            margin-bottom: 20px;
            border-radius: 3px;
            overflow: hidden;
            width: 100%;
        }
        .timer-bar { 
            height: 100%; 
            background-color: #0d6efd; 
            width: 100%; 
            /* ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì œê±° (ì¦‰ê° ë°˜ì‘ ìœ„í•´) or ì§§ê²Œ ì„¤ì • */
            transition: width 0.05s linear; 
        }
        .timer-bar.danger { background-color: #dc3545; }

        /* [í•™ìŠµ ëª¨ë“œ] í„°ì¹˜ ì˜ì—­ - í™”ë©´ ì „ì²´ í™œìš© */
        .touch-area {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin: 20px 0;
            border-radius: 15px;
            background-color: #ffffff; /* íˆ¬ëª…ë„ ì œê±° */
            /* í´ë¦­ ëª…í™•ì„±ì„ ìœ„í•´ í…Œë‘ë¦¬ ì¶”ê°€ */
            border: 2px dashed #dee2e6;
        }
        .touch-area:active { background-color: #f8f9fa; border-color: #adb5bd; }
        .tap-hint { color: #adb5bd; font-size: 0.9rem; margin-top: 15px; }

        /* [ì‹œí—˜ ëª¨ë“œ] ì…ë ¥ì°½ */
        .input-answer {
            font-size: 1.3rem;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #dee2e6;
            margin-bottom: 0;
            width: 100%;
            background-color: #fff;
        }
        .input-answer:focus { border-color: #0d6efd; outline: none; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1); }
        .input-answer.correct { border-color: #198754; background-color: #d1e7dd; }
        .input-answer.wrong { border-color: #dc3545; background-color: #f8d7da; }

        /* ê²°ê³¼ í…Œì´ë¸” */
        .result-table th { background-color: #f8f9fa; text-align: center; white-space: nowrap; font-size: 0.9rem; }
        .result-table td { vertical-align: middle; padding: 12px 8px; font-size: 0.95rem; }
        .correct-row { background-color: #f6fff9; }
        .wrong-row { background-color: #fff5f5; }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
        .bottom-btn-area {
            margin-top: auto;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .btn-large {
            width: 100%;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 16px;
        }

        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (alert ëŒ€ì²´) */
        #toast-container {
            visibility: hidden;
            min-width: 250px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #toast-container.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* ì •ë‹µìš”ì²­ ë²„íŠ¼ í…ìŠ¤íŠ¸ ê¹¨ì§ ë°©ì§€ */
        .result-table button {
            white-space: nowrap !important;
            word-break: keep-all !important;
            padding: 6px 12px !important;
            min-width: 70px;
        }
    </style>
</head>
<body>
<div id="debug-console" style="position:fixed; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.8); color:yellow; font-size:12px; padding:10px; z-index:99999; display:none; max-height: 150px; overflow-y:scroll;"></div>
<div id="toast-container"></div>
<div class="exam-card">
    <input type="hidden" id="csrfTokenVal" value="{{ csrf_token }}">
    <div id="headerInfo">
        <div class="d-flex justify-content-between text-muted mb-3 small align-items-center">
            <span class="fw-bold text-truncate" style="max-width: 60%;">{{ book_title }}</span>
            <span class="badge bg-light text-dark border"><span id="currentIndex">1</span> / {{ words_json|length }}</span>
        </div>
        
        <div class="timer-container" id="timerContainer">
            <div id="timerBar" class="timer-bar"></div>
        </div>
    </div>

    <div id="questionArea" style="display: contents;">
        
        <div class="d-flex justify-content-center align-items-center mt-2 mb-3">
            <div id="wordQuestion" class="word-display">Ready</div>
            <div class="pronunciation-btn shadow-sm" onclick="speakWord(event)">ğŸ”Š</div>
        </div>

        <div id="learningArea" style="display: none; flex-grow: 1; flex-direction: column;">
            <div class="touch-area" onclick="handleLearningClick()">
                <div id="learningAnswer" class="fs-1 fw-bold text-primary mb-3 text-center" style="display:none;"></div>
                <div id="learningExample" class="text-muted fst-italic px-3 text-center" style="display:none; line-height: 1.5;"></div>
                
                <div id="touchHint" class="tap-hint">
                    ğŸ‘† í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ì •ë‹µì´ ë³´ì…ë‹ˆë‹¤
                </div>
            </div>

            <div class="bottom-btn-area">
                <button id="nextWordBtn" class="btn btn-primary btn-large shadow" style="display:none;" onclick="nextQuestion()">
                    ë‹¤ìŒ ë‹¨ì–´ <small class="fw-normal">(Touch)</small>
                </button>
            </div>
        </div>

        <div id="testArea" style="display: none; flex-grow: 1;">
            <div class="d-flex flex-column justify-content-center h-50">
                <form id="answerForm" onsubmit="event.preventDefault(); checkAnswer();" autocomplete="off">
                    <input type="text" id="answerInput" class="input-answer shadow-sm" 
                           placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" 
                           enterkeyhint="go"
                           autocomplete="off">
                </form>
                <div class="text-center mt-3 text-muted small">
                    ì…ë ¥ í›„ <span class="badge bg-secondary">ì—”í„°</span> ë˜ëŠ” <span class="badge bg-secondary">ì´ë™</span>ì„ ëˆ„ë¥´ì„¸ìš”
                </div>
            </div>
            </div>
    </div>

    <div id="resultArea" style="display: none;">
        <h3 class="fw-bold mb-4 text-center" id="scoreTitle">ê²°ê³¼ ë¦¬í¬íŠ¸</h3>
        <div class="alert alert-light border mb-4 text-center shadow-sm" id="scoreMsg"></div>
        
        <div class="table-responsive border rounded-3 mb-4 shadow-sm" style="max-height: 50vh; overflow-y: auto;">
            <table class="table result-table mb-0">
                <thead class="sticky-top border-bottom">
                    <tr>
                        <th>ë‹¨ì–´</th>
                        <th>ë‚´ ë‹µ</th>
                        <th>ì •ë‹µ</th>
                        <th>ê²°ê³¼</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>

        <div class="bottom-btn-area">
            <a href="/vocab/" class="btn btn-primary btn-large shadow">í™•ì¸ (ë©”ì¸ìœ¼ë¡œ)</a>
        </div>
    </div>

</div>

<script>
    // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const words = {{ words_json|safe }};
    const mode = "{{ mode }}"; 
    const isPractice = {{ is_practice|yesno:"true,false" }};
    const isLearning = {{ is_learning|yesno:"true,false" }};
    const isMonthly = {{ is_monthly|yesno:"true,false" }};
    const testId = "{{ test_id|default:'' }}";

    // ìƒíƒœ ë³€ìˆ˜
    let currentIndex = 0;
    let score = 0;
    let userAnswers = [];
    let isProcessing = false; 
    
    // íƒ€ì´ë¨¸ ê´€ë ¨
    let timerInterval = null;
    let timeLeft = 5000;
    const totalTime = 5000;

    // DOM ìš”ì†Œ
    const wordEl = document.getElementById('wordQuestion');
    const inputEl = document.getElementById('answerInput');
    const timerBar = document.getElementById('timerBar');
    const timerContainer = document.getElementById('timerContainer');
    
    // í•™ìŠµ ëª¨ë“œ ìš”ì†Œ
    const learningArea = document.getElementById('learningArea');
    const learningAnswer = document.getElementById('learningAnswer');
    const learningExample = document.getElementById('learningExample');
    const touchHint = document.getElementById('touchHint');
    const nextWordBtn = document.getElementById('nextWordBtn');
    
    const testArea = document.getElementById('testArea');

    // === ì‹œì‘ ===
    window.onload = function() {
        if (!words || words.length === 0) {
            alert("í•™ìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = "/vocab/";
            return;
        }
        
        if (isLearning) {
            timerContainer.style.visibility = 'hidden';
            testArea.style.display = 'none';
            learningArea.style.display = 'flex';
        } else {
            learningArea.style.display = 'none';
            testArea.style.display = 'block';
        }

        showQuestion();
    };

    // === ë¬¸ì œ í‘œì‹œ ===
    function showQuestion() {
        isProcessing = false;
        
        const currentWord = words[currentIndex];
        wordEl.innerText = currentWord.english;
        document.getElementById('currentIndex').innerText = currentIndex + 1;
        
        setTimeout(() => speakWord(), 300);

        if (isLearning) {
            learningAnswer.style.display = 'none';
            learningExample.style.display = 'none';
            learningAnswer.innerText = currentWord.korean;
            learningExample.innerText = currentWord.example || "";
            touchHint.style.display = 'block';
            nextWordBtn.style.display = 'none';
        } else {
            inputEl.value = "";
            inputEl.disabled = false;
            // [ìˆ˜ì •] ìƒ‰ìƒ ì´ˆê¸°í™” ì½”ë“œ ì‚­ì œ (ë” ì´ìƒ ìƒ‰ì„ ì•ˆ ì…íˆë¯€ë¡œ ì´ˆê¸°í™”ë„ í•„ìš” ì—†ìŒ)
            inputEl.focus();
            resetAndStartTimer();
        }
    }

    // === [í•™ìŠµ ëª¨ë“œ] í„°ì¹˜ ë¡œì§ ===
    window.handleLearningClick = function() {
        if (learningAnswer.style.display === 'block') return;
        learningAnswer.style.display = 'block';
        learningExample.style.display = 'block';
        touchHint.style.display = 'none';
        nextWordBtn.style.display = 'block';
    };

    // === [ì‹œí—˜ ëª¨ë“œ] íƒ€ì´ë¨¸ ===
    function resetAndStartTimer() {
        if (isLearning) return;
        if (timerInterval) clearInterval(timerInterval);
        
        timeLeft = totalTime;
        timerBar.style.width = "100%";
        timerBar.classList.remove('danger');

        timerInterval = setInterval(() => {
            timeLeft -= 50;
            const percent = (timeLeft / totalTime) * 100;
            timerBar.style.width = percent + "%";
            if (percent < 30) timerBar.classList.add('danger');

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (!isProcessing) {
                    processResult(false, "(ì‹œê°„ ì´ˆê³¼)");
                }
            }
        }, 50);
    }

    // === [ì‹œí—˜ ëª¨ë“œ] ì •ë‹µ ì²´í¬ ===
    window.checkAnswer = function() {
        if (isLearning) return;
        if (isProcessing) return;

        const userInput = inputEl.value.trim();
        const dbAnswer = words[currentIndex].korean; 
        
        if (!userInput) return; 

        const correctAnswers = dbAnswer.split(',').map(word => word.trim());
        const isCorrect = correctAnswers.includes(userInput);

        processResult(isCorrect, userInput);
    }

    function processResult(isCorrect, userInput) {
        isProcessing = true;
        clearInterval(timerInterval);
        
        // [ìˆ˜ì •] ì •ë‹µ/ì˜¤ë‹µ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½ ì½”ë“œ ì‚­ì œ
        // if (isCorrect) inputEl.classList.add('correct');
        // else inputEl.classList.add('wrong');

        userAnswers.push({
            english: words[currentIndex].english,
            korean: words[currentIndex].korean,
            user_input: userInput,
            is_correct: isCorrect
        });

        if (isCorrect) score++;

        setTimeout(nextQuestion, 200);
    }

    // === ë‹¤ìŒ ë¬¸ì œ ì´ë™ ===
    window.nextQuestion = function() {
        currentIndex++;
        if (currentIndex < words.length) {
            showQuestion();
        } else {
            finishExam();
        }
    }

    // === TTS ===
    let voices = [];

    // ê¸°ê¸°ì˜ ëª©ì†Œë¦¬ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function setVoiceList() {
        voices = window.speechSynthesis.getVoices();
    }

    // ëª©ì†Œë¦¬ ëª©ë¡ì€ ë¹„ë™ê¸°ë¡œ ë¡œë“œë˜ë¯€ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = setVoiceList;
    }

    window.speakWord = function(event) {
        if(event) event.stopPropagation();
        
        if ('speechSynthesis' in window) {
            // ê¸°ì¡´ ëŒ€ê¸°ì—´ ì·¨ì†Œ
            window.speechSynthesis.cancel();

            const text = words[currentIndex].english;
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 1. ê¸°ë³¸ ì–¸ì–´ ì„¤ì •
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9; // ì†ë„ (0.1 ~ 10)

            // 2. [í•µì‹¬] ë¯¸êµ­ ì˜ì–´ ëª©ì†Œë¦¬ ê°•ì œ ì°¾ê¸°
            // ëª©ì†Œë¦¬ ëª©ë¡ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ë‹¤ì‹œ í˜¸ì¶œ
            if (voices.length === 0) {
                voices = window.speechSynthesis.getVoices();
            }

            // ìš°ì„ ìˆœìœ„: 
            // 1. "Samantha" (ì•„ì´í°ì˜ ëŒ€í‘œì ì¸ ë¯¸êµ­ ì—¬ì„± ëª©ì†Œë¦¬)
            // 2. ì´ë¦„ì— "US"ë‚˜ "United States"ê°€ ë“¤ì–´ê°„ ëª©ì†Œë¦¬
            // 3. ì–¸ì–´ ì½”ë“œê°€ "en-US"ì¸ ëª©ì†Œë¦¬
            const targetVoice = voices.find(v => v.name === 'Samantha') || 
                                voices.find(v => v.lang === 'en-US' && v.name.includes('US')) ||
                                voices.find(v => v.lang === 'en-US');

            // ì°¾ì€ ëª©ì†Œë¦¬ê°€ ìˆìœ¼ë©´ ì ìš©
            if (targetVoice) {
                utterance.voice = targetVoice;
            }

            window.speechSynthesis.speak(utterance);
        }
    }

    // === ê²°ê³¼ ì²˜ë¦¬ ===
    function finishExam() {
        document.getElementById('headerInfo').style.display = 'none';
        document.getElementById('questionArea').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';

        if (isLearning) {
            document.getElementById('scoreTitle').innerText = "í•™ìŠµ ì™„ë£Œ";
            document.getElementById('scoreMsg').innerText = "ì˜¤ëŠ˜ì˜ ë‹¨ì–´ í•™ìŠµì„ ë§ˆì³¤ìŠµë‹ˆë‹¤!";
            renderTable([]);
            return;
        }

        if (!isPractice) {
            saveResultToServer();
        } else {
            document.getElementById('scoreMsg').innerHTML = `<strong>ì—°ìŠµ ê²°ê³¼:</strong> ${score} / ${words.length} ì `;
            renderTable(null);
        }
    }

    function saveResultToServer() {
        const data = {
            test_id: testId,
            mode: mode,
            score: score,
            wrong_count: words.length - score,
            details: userAnswers,
            is_monthly: isMonthly
        };

        fetch("{% url 'vocab:save_result' %}", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // [ìˆ˜ì •] ì›”ë§í‰ê°€(85ì )ì™€ ì¼ë°˜ì‹œí—˜(27ì ) í†µê³¼ ê¸°ì¤€ ë¶„ë¦¬ ì ìš©
                let isPass = false;
                if (isMonthly) {
                    isPass = score >= 85; // ì›”ë§í‰ê°€ ê¸°ì¤€
                } else {
                    isPass = score >= 27; // ë„ì „/ì˜¤ë‹µëª¨ë“œ ê¸°ì¤€ (30ë¬¸ì œ ì¤‘ 27)
                }

                const passMsg = !isPass 
                    ? "<br><span class='text-danger fw-bold'>ë¶ˆí•©ê²© (ì¬ì‹œí—˜ í•„ìš”)</span>" 
                    : "<br><span class='text-success fw-bold'>í†µê³¼! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.</span>";
                
                document.getElementById('scoreMsg').innerHTML = `<strong>ìµœì¢… ì ìˆ˜:</strong> ${score}ì  ${passMsg}`;
                renderTable(data.detail_ids);
            } else {
                alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
            }
        });
    }

    function renderTable(detailIds) {
    const tbody = document.getElementById('resultTableBody');
    tbody.innerHTML = "";

    userAnswers.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.className = item.is_correct ? 'correct-row' : 'wrong-row';
        
        let status = item.is_correct ? '<span class="text-success fw-bold">O</span>' : '<span class="text-danger fw-bold">X</span>';
        
        if (!item.is_correct && detailIds && detailIds.length > index) {
            const detailId = detailIds[index];
            
            // [í•µì‹¬ ìˆ˜ì •]
            // 1. onclickê³¼ ontouchendë¥¼ ë‘˜ ë‹¤ ë„£ì–´ì„œ í„°ì¹˜ ì¸ì‹ë¥  2ë°° ë†’ì„
            // 2. ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ 'ìš”ì²­ v3'ë¡œ ë³€ê²½í•˜ì—¬ ìºì‹œ ê°±ì‹  í™•ì¸
            status += `<br><button type="button" class="btn btn-outline-secondary btn-sm mt-1 shadow-sm" 
                        style="font-size: 0.7rem; padding: 4px 8px;" 
                        ontouchend="window.requestCorrection(${detailId}, this); event.stopPropagation();" 
                        onclick="window.requestCorrection(${detailId}, this);">
                        ìš”ì²­ v3</button>`;
        }

        tr.innerHTML = `
            <td class="fw-bold">${item.english}</td>
            <td class="small">${item.user_input || '-'}</td>
            <td class="small text-primary">${item.korean}</td>
            <td class="text-center">${status}</td>
        `;
        tbody.appendChild(tr);
    });
}

        window.requestCorrection = function(detailId, btn) {
            // 1. í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê°•ì œ ì•Œë¦¼ (ì„±ê³µ í™•ì¸ í›„ ì‚­ì œí•˜ì„¸ìš”)
            // alert("ë²„íŠ¼ì´ ëˆŒë ¸ìŠµë‹ˆë‹¤! ID: " + detailId); 

            // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ (ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ë¬´ì‹œ)
            if (btn.disabled) return;

            // 2. UI ì¦‰ì‹œ ë³€ê²½
            btn.disabled = true;
            var originalText = btn.innerText;
            btn.innerText = "ì „ì†¡ì¤‘..";

            // 3. í† í° ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ë¹ˆ ê°’)
            var csrfInput = document.getElementById('csrfTokenVal');
            var csrfToken = csrfInput ? csrfInput.value : '';

            // 4. fetch ìš”ì²­ (async/await ì—†ì´ .then ì‚¬ìš©)
            fetch("/vocab/request_correction/", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({ detail_id: detailId, is_monthly: isMonthly })
            })
            .then(function(response) {
                // ì‘ë‹µ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                return response.text().then(function(text) {
                    // HTML(ë¡œê·¸ì¸ì°½)ì´ ì™”ëŠ”ì§€ ê²€ì‚¬
                    if (text.trim().indexOf("<") === 0) {
                        throw new Error("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
                    }
                });
            })
            .then(function(data) {
                if (data.status === 'success') {
                    // ì„±ê³µ
                    btn.innerText = "ì™„ë£Œ";
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-secondary');
                    // í† ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ë„ìš°ê³  ì—†ìœ¼ë©´ alert (ì•ˆì „ì¥ì¹˜)
                    if (typeof showToast === 'function') showToast("âœ… ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    else alert("âœ… ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    // ì‹¤íŒ¨ ë©”ì‹œì§€
                    alert("ì•Œë¦¼: " + data.message);
                    btn.disabled = false;
                    btn.innerText = "ìš”ì²­ v3";
                }
            })
            .catch(function(err) {
                // ì—ëŸ¬ ë°œìƒ
                console.error(err);
                alert("ì˜¤ë¥˜: " + err.message);
                btn.disabled = false;
                btn.innerText = "ìš”ì²­ v3";
            });
        };
</script>

</body>
</html>