<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹œí—˜ ê²°ê³¼ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 30px; }
        .container { max-width: 900px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .correct-row { background-color: #f0fff4; } /* ì •ë‹µ: ì—°í•œ ì´ˆë¡ */
        .wrong-row { background-color: #fff5f5; }   /* ì˜¤ë‹µ: ì—°í•œ ë¹¨ê°• */
        .info-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            height: 100%;
        }
        .info-label { font-size: 0.85rem; color: #868e96; margin-bottom: 5px; font-weight: 600; }
        .info-value { font-size: 1.1rem; font-weight: 700; color: #343a40; word-break: keep-all; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold m-0 text-primary">ğŸ“„ ì‹œí—˜ ê²°ê³¼ ìƒì„¸í‘œ</h4>
        <a href="{{ back_url|default:'/admin/vocab/testresult/' }}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            â¬… ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="info-box">
                <div class="info-label">í•™ìƒ ì´ë¦„</div>
                <div class="info-value">
                    {{ result.student.profile.name|default:result.student.username }}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="info-box">
                <div class="info-label">ì‹œí—˜ ë‹¨ì–´ì¥</div>
                <div class="info-value">
                    {{ result.book.title|default:"-" }}
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="info-box">
                <div class="info-label">ì‹œí—˜ ë²”ìœ„</div>
                <div class="info-value text-primary">
                    {% if result.test_range == 'ì˜¤ë‹µì§‘ì¤‘' %}
                        ì˜¤ë‹µë‹¨ì–´
                    {% else %}
                        {{ result.test_range }}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="info-box text-center" style="background-color: #fff9db; border-color: #ffec99;">
                <div class="info-label text-warning">ì ìˆ˜</div>
                <div class="info-value" id="totalScore" style="font-size: 1.5rem; color: #e67700;">
                    {{ result.score }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-end text-muted small mb-2">
        ì‹œí—˜ ì¼ì‹œ: {{ result.created_at|date:"Yë…„ mì›” dì¼ H:i" }}
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle border">
            <thead class="table-light">
                <tr class="text-center">
                    <th style="width: 30%;">ë¬¸ì œ (ì˜ì–´)</th>
                    <th style="width: 20%;">í•™ìƒ ë‹µì•ˆ</th>
                    <th style="width: 30%;">ì •ë‹µ (í•œêµ­ì–´)</th>
                    <th style="width: 10%;">ê²°ê³¼</th>
                    <th style="width: 10%;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for detail in details %}
                <tr id="row-{{ detail.id }}" class="{% if detail.is_correct %}correct-row{% else %}wrong-row{% endif %}">
                    <td class="fw-bold ps-3">{{ detail.word_question }}</td>
                    <td class="text-center">{{ detail.student_answer }}</td>
                    <td class="text-center text-primary">{{ detail.correct_answer }}</td>
                    
                    <td class="text-center" id="status-{{ detail.id }}">
                        {% if detail.is_correct %}
                            <span class="badge bg-success rounded-pill">ì •ë‹µ</span>
                        {% else %}
                            <span class="badge bg-danger rounded-pill">ì˜¤ë‹µ</span>
                        {% endif %}
                    </td>

                    <td class="text-center">
                        {% if not detail.is_correct %}
                            <button class="btn btn-sm btn-outline-primary shadow-sm" 
                                    onclick="approveAnswer({{ detail.id }})"
                                    style="font-size: 0.8rem;">
                                ğŸ”” ì¸ì •í•˜ê¸°
                            </button>
                        {% else %}
                            <span class="text-muted small">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function approveAnswer(detailId) {
        if (!confirm("ì´ ì˜¤ë‹µì„ 'ì •ë‹µ'ìœ¼ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì ìˆ˜ê°€ 1ì  ì˜¤ë¦…ë‹ˆë‹¤)")) return;

        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        const row = document.getElementById('row-' + detailId);
        const btn = row.querySelector('button');
        if (btn) {
            btn.disabled = true;
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";
        }

        fetch("{% url 'vocab:approve_answer' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ detail_id: detailId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert("ì •ë‹µ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. (ì¿¨íƒ€ì„ í•´ì œ ì—¬ë¶€ ìë™ í™•ì¸ë¨)");
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('totalScore').innerText = data.new_score;
                row.className = 'correct-row';
                const statusCell = document.getElementById('status-' + detailId);
                statusCell.innerHTML = '<span class="badge bg-success rounded-pill">ì •ë‹µ (ìˆ˜ë™)</span>';
                if(btn) btn.style.display = 'none';
                
            } else if (data.status === 'already_correct') {
                alert("ì´ë¯¸ ì •ë‹µ ì²˜ë¦¬ëœ í•­ëª©ì…ë‹ˆë‹¤.");
                location.reload();
            } else {
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.message);
                if(btn) { btn.disabled = false; btn.innerText = "ğŸ”” ì¸ì •í•˜ê¸°"; }
            }
        })
        .catch(err => {
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            if(btn) { btn.disabled = false; btn.innerText = "ğŸ”” ì¸ì •í•˜ê¸°"; }
        });
    }
</script>

</body>
</html>