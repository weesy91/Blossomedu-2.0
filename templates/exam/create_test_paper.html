<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ì§€ ìƒì„± - Blossom Edu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    body { background-color: #f5f7fa; }
    .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .form-label { font-weight: bold; color: #495057; }
    
    /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ ê°•í™” */
    .form-range { height: 1.5rem; }
    .form-range::-webkit-slider-runnable-track {
        background: #dee2e6; height: 0.5rem; border-radius: 1rem;
    }
    .form-range::-webkit-slider-thumb {
        background: #0d6efd; width: 1.5rem; height: 1.5rem; margin-top: -0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.15s ease-in-out;
    }
    .form-range:active::-webkit-slider-thumb { background: #0a58ca; cursor: grabbing; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        {% if user.is_superuser %}
            <a href="{% url 'academy:director_dashboard' %}" class="btn btn-outline-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
        {% else %}
            <a href="{% url 'core:teacher_home' %}" class="btn btn-outline-secondary">â† ë‚´ ìˆ˜ì—… ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        {% endif %}
        <h4 class="fw-bold text-primary">ğŸ–¨ï¸ ì›”ë§í‰ê°€ ì‹œí—˜ì§€ ìƒì„±</h4>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card p-4">
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-danger">{{ message }}</div>
                    {% endfor %}
                {% endif %}

                <form method="POST">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label class="form-label">1. ë‹´ë‹¹ ì„ ìƒë‹˜</label>
                        {{ form.teacher }}
                    </div>

                    <div class="mb-4">
                        <label class="form-label">2. ì‘ì‹œ í•™ìƒ</label>
                        {{ form.student }}
                        <div class="form-text text-primary" id="student-msg">
                            ğŸ‘† ë¨¼ì € ì„ ìƒë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">3. ì¶œì œ ë²”ìœ„ (êµì¬ & ê°•)</label>
                        {{ form.textbook }}
                        <div class="input-group mt-2">
                            <span class="input-group-text bg-white">Start</span>
                            {{ form.start_chapter }}
                            <span class="input-group-text bg-white">End</span>
                            {{ form.end_chapter }}
                        </div>
                    </div>

                    <div class="mb-4 p-3 bg-light rounded">
                        <label class="form-label mb-3">4. ë‚œì´ë„ ë° ë¹„ìœ¨ ì„¤ì • (ê°œë… ë¬¸ì œ ë¹„ìœ¨)</label>
                        
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-danger small fw-bold">ğŸ”´ êµ¬ë¬¸/ë¶„ì„ ìœ„ì£¼ (0%)</span>
                            <span class="text-success small fw-bold">ğŸŸ¢ ê°œë…/ì´ë¡  ìœ„ì£¼ (100%)</span>
                        </div>
                        
                        {{ form.concept_ratio }}
                        
                        <div class="d-flex justify-content-between mt-1 text-muted small">
                            <span>0% (ì „ë¶€ ë¶„ì„)</span>
                            <span id="ratioDisplay" class="fw-bold text-dark">50%</span>
                            <span>100% (ì „ë¶€ ê°œë…)</span>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label small">ì´ ë¬¸ì œ ìˆ˜</label>
                            {{ form.total_questions }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">5. ì‹œí—˜ì§€ ì œëª© (ì„ íƒ)</label>
                        {{ form.custom_title }}
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg fw-bold">
                            ì‹œí—˜ì§€ ìƒì„±í•˜ê¸° âœ¨
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // [1] ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ë¡œì§
        const rangeInput = document.querySelector('input[type="range"]');
        const display = document.getElementById('ratioDisplay');
        if(rangeInput) {
            rangeInput.addEventListener('input', function() {
                display.innerText = this.value + '%';
            });
        }

        // [2] ì„ ìƒë‹˜ -> í•™ìƒ ì—°ë™ ë¡œì§ (í•µì‹¬)
        const teacherSelect = document.getElementById('teacher-select');
        const studentSelect = document.getElementById('student-select');
        const studentMsg = document.getElementById('student-msg');

        function loadStudents() {
            const teacherId = teacherSelect.value;
            
            // ì´ˆê¸°í™”
            studentSelect.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (!teacherId) {
                studentSelect.disabled = true;
                return;
            }

            // API í˜¸ì¶œ
            fetch(`/exam/api/students/?teacher_id=${teacherId}`)
                .then(response => response.json())
                .then(data => {
                    const students = data.students;
                    
                    if (students.length === 0) {
                        studentMsg.innerText = "ğŸ˜¢ ë‹´ë‹¹ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
                        studentSelect.disabled = true;
                    } else {
                        studentMsg.innerText = `ì´ ${students.length}ëª…ì˜ í•™ìƒì´ ì¡°íšŒë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        studentSelect.disabled = false;
                        
                        students.forEach(s => {
                            const option = document.createElement('option');
                            option.value = s.id;
                            option.textContent = s.name;
                            studentSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    studentMsg.innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        if (teacherSelect) {
            teacherSelect.addEventListener('change', loadStudents);
            
            // í˜ì´ì§€ ë¡œë”© ì‹œ ì„ ìƒë‹˜ì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆë‹¤ë©´(ì¼ë°˜ ê°•ì‚¬ ë“±) ì¦‰ì‹œ ì‹¤í–‰
            if (teacherSelect.value) {
                loadStudents();
            } else {
                studentSelect.disabled = true;
            }
        }
    });
</script>

</body>
</html>